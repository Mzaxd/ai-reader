<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Reader - Library Prototype (Plan Aligned)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../tokens.css">
  <style>
    :root {
      --left-pane: 250px;
      --right-pane: 340px;
    }

    body {
      height: 100vh;
      overflow: hidden;
    }

    .app {
      height: 100vh;
      display: grid;
      grid-template-rows: var(--app-titlebar-h) 1fr var(--app-statusbar-h);
    }

    .title-left {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .duck {
      width: 28px;
      height: 28px;
      border: var(--md-border-strong);
      border-radius: 50%;
      background: var(--md-sun);
      position: relative;
      flex: 0 0 auto;
    }

    .duck::before {
      content: "";
      position: absolute;
      right: -3px;
      top: 9px;
      width: 12px;
      height: 8px;
      border: var(--md-border-strong);
      border-radius: 6px;
      background: var(--md-orange);
    }

    .duck::after {
      content: "";
      position: absolute;
      left: 9px;
      top: 9px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--md-ink);
    }

    .title-left strong {
      font-family: var(--font-ui);
      font-size: 13px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title-center {
      width: min(520px, 42vw);
      position: relative;
    }

    .title-center .md-kbd {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }

    .workspace {
      min-height: 0;
      display: grid;
      grid-template-columns: var(--left-pane) minmax(0, 1fr) var(--right-pane);
    }

    .pane {
      min-height: 0;
      background: color-mix(in srgb, var(--md-surface-1) 94%, transparent);
    }

    .left {
      border-right: var(--md-border-strong);
      padding: 10px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 8px;
    }

    .nav-list,
    .quick-list {
      display: grid;
      gap: 6px;
    }

    .nav-item {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      padding: 8px 9px;
      background: var(--md-surface-1);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      transition: transform var(--dur-fast) var(--ease-out), background-color var(--dur-fast) var(--ease-out), border-color var(--dur-fast) var(--ease-out);
    }

    .nav-item:hover {
      transform: translateY(-1px);
      border-color: var(--md-border-mid);
      background: var(--md-surface-2);
    }

    .nav-item.active {
      border: var(--md-border-strong);
      background: color-mix(in srgb, var(--md-sky) 24%, var(--md-surface-1));
    }

    .main {
      padding: 10px;
      min-height: 0;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 8px;
      overflow: hidden;
    }

    .notice {
      border: var(--md-border-strong);
      border-radius: 8px;
      background: color-mix(in srgb, var(--md-sun) 40%, var(--md-surface-1));
      padding: 8px 10px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar-right {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .scroll {
      min-height: 0;
      overflow: auto;
      display: grid;
      gap: 8px;
      align-content: start;
      padding-right: 2px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .stat {
      border: var(--md-border-strong);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 9px;
      display: grid;
      gap: 4px;
    }

    .stat strong {
      font-size: 28px;
      line-height: 1;
    }

    .stat.sky { background: color-mix(in srgb, var(--md-sky) 20%, var(--md-surface-1)); }
    .stat.sun { background: color-mix(in srgb, var(--md-sun) 26%, var(--md-surface-1)); }
    .stat.orange { background: color-mix(in srgb, var(--md-orange) 20%, var(--md-surface-1)); }

    .import {
      border: 2px dashed var(--md-border-mid);
      border-radius: 10px;
      background: linear-gradient(145deg, var(--md-surface-1), var(--md-surface-3));
      padding: 11px;
      transition: border-color var(--dur-fast) var(--ease-out), background-color var(--dur-fast) var(--ease-out);
    }

    .import.active {
      border-color: var(--md-sky-strong);
      background: linear-gradient(145deg, var(--md-surface-1), color-mix(in srgb, var(--md-sky) 18%, var(--md-surface-1)));
    }

    .import-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 8px;
    }

    .format-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin: 6px 0 8px;
    }

    .format {
      border: var(--md-border-strong);
      border-radius: 6px;
      padding: 3px 8px;
      background: var(--md-surface-1);
      font-family: var(--font-ui);
      font-size: 11px;
      text-transform: uppercase;
    }

    .format.exp {
      border-color: var(--md-warning);
      background: color-mix(in srgb, var(--md-warning) 20%, var(--md-surface-1));
    }

    .file-check {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 8px;
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .warning {
      border: var(--md-border-strong);
      border-radius: 8px;
      background: color-mix(in srgb, var(--md-danger) 18%, var(--md-surface-1));
      padding: 8px;
      font-size: 13px;
    }

    .task-list {
      display: grid;
      gap: 6px;
      margin-top: 6px;
    }

    .task-row {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 7px;
      display: grid;
      gap: 6px;
      font-size: 12px;
    }

    .task-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .tiny-meter {
      height: 8px;
      border: var(--md-border-soft-line);
      border-radius: 999px;
      overflow: hidden;
      background: var(--md-surface-2);
    }

    .tiny-meter span {
      display: block;
      width: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--md-sky), var(--md-sun));
      transition: width 380ms var(--ease-out);
    }

    .books-head {
      display: flex;
      align-items: end;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .books {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .book {
      border: var(--md-border-strong);
      border-radius: 8px;
      overflow: hidden;
      background: var(--md-surface-1);
      transition: transform var(--dur-fast) var(--ease-out), box-shadow var(--dur-fast) var(--ease-out);
    }

    .book:hover {
      transform: translateY(-2px);
      box-shadow: var(--md-shadow-lift);
    }

    .cover {
      aspect-ratio: 7 / 9;
      border-bottom: var(--md-border-strong);
      display: grid;
      place-items: center;
      text-align: center;
      line-height: 1.25;
      font-weight: 800;
      padding: 10px;
      color: #1d1d1d;
    }

    .cover.sky { background: linear-gradient(145deg, #6fc2ff, #b9e3ff); }
    .cover.sun { background: linear-gradient(145deg, #ffde00, #fff4a4); }
    .cover.orange { background: linear-gradient(145deg, #ff9538, #ffd3a8); }
    .cover.cream { background: linear-gradient(145deg, #f4efea, #ffffff); }

    .book-body {
      padding: 8px 9px;
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .book-title {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: start;
    }

    .book-title h3 {
      margin: 0;
      font-size: 15px;
      line-height: 1.35;
    }

    .meter {
      height: 10px;
      border: var(--md-border-strong);
      border-radius: 999px;
      overflow: hidden;
      background: var(--md-surface-1);
    }

    .meter span {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--md-sky), var(--md-mint));
      transition: width 650ms var(--ease-out);
    }

    .book-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .right {
      border-left: var(--md-border-strong);
      padding: 10px;
      min-height: 0;
      overflow: auto;
      display: grid;
      gap: 8px;
      align-content: start;
    }

    .panel {
      border: var(--md-border-strong);
      border-radius: 8px;
      overflow: hidden;
      background: var(--md-surface-1);
    }

    .panel .head {
      border-bottom: var(--md-border-strong);
      padding: 8px 9px;
      font-family: var(--font-ui);
      font-size: 12px;
      text-transform: uppercase;
      background: var(--md-surface-1);
    }

    .panel .body {
      padding: 8px 9px;
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .row-item {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 7px 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .status-l,
    .status-r {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .sep {
      width: 1px;
      height: 16px;
      background: var(--md-border-soft);
    }

    @media (max-width: 1320px) {
      :root {
        --right-pane: 300px;
      }
      .books {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 1080px) {
      .workspace {
        grid-template-columns: var(--left-pane) 1fr;
      }
      .right {
        display: none;
      }
      .import-grid {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 860px) {
      .workspace {
        grid-template-columns: 1fr;
      }
      .left {
        display: none;
      }
      .books {
        grid-template-columns: 1fr;
      }
      .toolbar {
        grid-template-columns: 1fr;
      }
      .title-center {
        display: none;
      }
      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="md-noise">
  <div class="app">
    <header class="md-titlebar">
      <div class="title-left">
        <span class="duck" aria-hidden="true"></span>
        <strong>AI Reader Library</strong>
      </div>
      <div class="title-center">
        <input class="md-input" id="searchInput" placeholder="搜索书名、作者、章节、人物...">
        <span class="md-kbd">Ctrl/Cmd + F</span>
      </div>
      <div class="row">
        <button class="md-btn" id="themeToggle">Theme</button>
      </div>
    </header>

    <div class="workspace">
      <aside class="pane left">
        <div class="md-chip">Navigation</div>
        <div class="nav-list">
          <button class="nav-item active"><span>书库</span><span class="md-chip">24</span></button>
          <button class="nav-item"><span>最近阅读</span><span>历史</span></button>
          <button class="nav-item"><span>人物分析</span><span>P0</span></button>
          <button class="nav-item"><span>时间线分析</span><span>P0</span></button>
          <button class="nav-item"><span>事件分析</span><span>P0</span></button>
          <button class="nav-item"><span>AI 配置</span><span>API</span></button>
        </div>
        <div class="quick-list">
          <span class="md-chip">Shortcuts</span>
          <div class="row-item"><span>导入文件</span><span class="md-kbd">Ctrl/Cmd + I</span></div>
          <div class="row-item"><span>搜索书库</span><span class="md-kbd">Ctrl/Cmd + F</span></div>
          <div class="row-item"><span>继续阅读</span><span class="md-kbd">Ctrl/Cmd + R</span></div>
        </div>
      </aside>

      <main class="pane main">
        <div class="notice">
          <span>计划对齐模式：仅保留计划内功能。当前离线模式可用，网络恢复后将自动同步分析任务。</span>
          <span class="md-chip">Plan First</span>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <button class="md-btn md-btn-primary" id="importBtn">Import Book</button>
            <button class="md-btn md-btn-accent">Continue Reading</button>
            <button class="md-btn">AI Settings</button>
            <span class="md-chip">RAG Ready</span>
          </div>
          <div class="toolbar-right">
            <select class="md-select" id="sortSelect" aria-label="排序">
              <option value="recent">最近阅读</option>
              <option value="progress">阅读进度</option>
              <option value="title">书名</option>
            </select>
          </div>
          <div class="toolbar-right">
            <span class="md-chip" id="resultCount">8 results</span>
          </div>
        </div>

        <div class="scroll">
          <section class="stats">
            <article class="stat sky"><span class="md-ui">Books</span><strong>24</strong><span>支持 EPUB/TXT/DOC/DOCX/MOBI/AZW</span></article>
            <article class="stat sun"><span class="md-ui">RAG Chunks</span><strong>8.4k</strong><span>向量检索已建立</span></article>
            <article class="stat orange"><span class="md-ui">Token Today</span><strong>182k</strong><span>预算占用 63%</span></article>
            <article class="stat"><span class="md-ui">Offline Queue</span><strong>2</strong><span>等待联网提交</span></article>
          </section>

          <section class="import" id="dropzone">
            <div class="import-grid">
              <div>
                <h2 style="margin:0; font-size:20px;">Import Pipeline</h2>
                <p style="margin:4px 0 0; font-size:13px; color:var(--md-ink-soft);">导入后执行：格式校验 -> 编码检测 -> 元数据提取 -> 分块索引 -> RAG 向量化。</p>
                <div class="format-row">
                  <span class="format">EPUB</span>
                  <span class="format">TXT</span>
                  <span class="format">DOC/DOCX</span>
                  <span class="format exp">MOBI/AZW (P1)</span>
                </div>
                <div class="row">
                  <button class="md-btn md-btn-primary">选择文件</button>
                  <button class="md-btn">查看导入历史</button>
                </div>
              </div>
              <div class="file-check">
                <strong>导入校验（计划项）</strong>
                <label for="sizeRange">模拟文件大小: <span id="sizeLabel">12</span> MB</label>
                <input type="range" id="sizeRange" min="1" max="120" value="12">
                <span>编码检测: UTF-8 / GBK / GB2312</span>
                <span>TXT 分章: 章节标题正则 + 多分隔符兼容</span>
                <span>元数据提取: 标题/作者/封面</span>
                <div class="warning" id="sizeWarning" hidden>大于 50MB，导入前需要确认（计划验收项）。</div>
                <div class="warning" id="formatWarning" hidden>解析失败：不支持的文件格式（仅支持计划内格式）。</div>
                <div class="task-list" id="importTasks">
                  <div class="task-row">
                    <div class="task-head"><span>格式校验</span><span class="md-chip" id="stageValidate">Ready</span></div>
                    <div class="tiny-meter"><span data-stage="validate"></span></div>
                  </div>
                  <div class="task-row">
                    <div class="task-head"><span>编码检测 + 元数据提取</span><span class="md-chip" id="stageMeta">Ready</span></div>
                    <div class="tiny-meter"><span data-stage="meta"></span></div>
                  </div>
                  <div class="task-row">
                    <div class="task-head"><span>分块索引 + 向量化</span><span class="md-chip" id="stageRag">Ready</span></div>
                    <div class="tiny-meter"><span data-stage="rag"></span></div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section>
            <div class="books-head">
              <div>
                <h2 style="margin:0; font-size:22px;">Library</h2>
                <p style="margin:2px 0 0; font-size:13px; color:var(--md-ink-soft);">包含计划要求：搜索、删除、阅读历史、进度追踪。</p>
              </div>
            </div>

            <div class="books" id="bookGrid">
              <article class="book" data-title="三体" data-author="刘慈欣" data-progress="72">
                <div class="cover sky">三体<br>刘慈欣</div>
                <div class="book-body">
                  <div class="book-title"><h3>三体</h3><span class="md-chip">阅读中</span></div>
                  <span>阅读历史: 2 小时前</span>
                  <span>书签: 11</span>
                  <div class="meter"><span data-p="72"></span></div>
                  <div class="book-actions">
                    <button class="md-btn">打开</button>
                    <button class="md-btn md-btn-danger delete-btn">删除</button>
                  </div>
                </div>
              </article>
              <article class="book" data-title="百年孤独" data-author="马尔克斯" data-progress="41">
                <div class="cover sun">百年孤独<br>马尔克斯</div>
                <div class="book-body">
                  <div class="book-title"><h3>百年孤独</h3><span class="md-chip">阅读中</span></div>
                  <span>阅读历史: 1 天前</span>
                  <span>书签: 4</span>
                  <div class="meter"><span data-p="41"></span></div>
                  <div class="book-actions">
                    <button class="md-btn">打开</button>
                    <button class="md-btn md-btn-danger delete-btn">删除</button>
                  </div>
                </div>
              </article>
              <article class="book" data-title="1984" data-author="George Orwell" data-progress="19">
                <div class="cover orange">1984<br>Orwell</div>
                <div class="book-body">
                  <div class="book-title"><h3>1984</h3><span class="md-chip">阅读中</span></div>
                  <span>阅读历史: 3 天前</span>
                  <span>书签: 2</span>
                  <div class="meter"><span data-p="19"></span></div>
                  <div class="book-actions">
                    <button class="md-btn">打开</button>
                    <button class="md-btn md-btn-danger delete-btn">删除</button>
                  </div>
                </div>
              </article>
              <article class="book" data-title="红楼梦" data-author="曹雪芹" data-progress="84">
                <div class="cover cream">红楼梦<br>曹雪芹</div>
                <div class="book-body">
                  <div class="book-title"><h3>红楼梦</h3><span class="md-chip">高进度</span></div>
                  <span>阅读历史: 6 小时前</span>
                  <span>书签: 18</span>
                  <div class="meter"><span data-p="84"></span></div>
                  <div class="book-actions">
                    <button class="md-btn">打开</button>
                    <button class="md-btn md-btn-danger delete-btn">删除</button>
                  </div>
                </div>
              </article>
            </div>
          </section>
        </div>
      </main>

      <aside class="pane right">
        <section class="panel">
          <div class="head">AI Providers</div>
          <div class="body">
            <div class="row-item"><span><i class="md-status-dot md-status-on"></i>OpenAI</span><span>Connected</span></div>
            <div class="row-item"><span><i class="md-status-dot md-status-on"></i>Claude</span><span>Connected</span></div>
            <div class="row-item"><span><i class="md-status-dot md-status-warn"></i>Ollama</span><span>Warming</span></div>
            <div class="row-item"><span><i class="md-status-dot md-status-off"></i>Network</span><span>Offline Queue ON</span></div>
          </div>
        </section>
        <section class="panel">
          <div class="head">成本与预算</div>
          <div class="body">
            <div class="row-item"><span>日预算</span><span>$5.00</span></div>
            <div class="row-item"><span>今日已用</span><span>$3.15 (63%)</span></div>
            <div class="row-item"><span>单次高成本阈值</span><span>$0.25</span></div>
            <div class="row-item"><span>Token 可视化</span><span>182k</span></div>
          </div>
        </section>
        <section class="panel">
          <div class="head">离线任务队列</div>
          <div class="body">
            <div class="row-item"><span>人物分析 · 三体</span><span>等待提交</span></div>
            <div class="row-item"><span>时间线分析 · 红楼梦</span><span>等待提交</span></div>
          </div>
        </section>
      </aside>
    </div>

    <footer class="md-statusbar">
      <div class="status-l">
        <span><i class="md-status-dot md-status-warn"></i>Offline Mode</span>
        <span class="sep"></span>
        <span>Auto-save: ON</span>
        <span class="sep"></span>
        <span>Memory: 312MB</span>
      </div>
      <div class="status-r">
        <span class="md-kbd">Ctrl/Cmd + I</span>
        <span class="md-kbd">Ctrl/Cmd + F</span>
      </div>
    </footer>
  </div>

  <script>
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const sizeRange = document.getElementById('sizeRange');
    const sizeLabel = document.getElementById('sizeLabel');
    const sizeWarning = document.getElementById('sizeWarning');
    const formatWarning = document.getElementById('formatWarning');
    const dropzone = document.getElementById('dropzone');
    const bookGrid = document.getElementById('bookGrid');
    const resultCount = document.getElementById('resultCount');
    const stageValidate = document.getElementById('stageValidate');
    const stageMeta = document.getElementById('stageMeta');
    const stageRag = document.getElementById('stageRag');
    const importBars = {
      validate: document.querySelector('[data-stage="validate"]'),
      meta: document.querySelector('[data-stage="meta"]'),
      rag: document.querySelector('[data-stage="rag"]'),
    };
    const books = Array.from(bookGrid.querySelectorAll('.book'));

    const syncMeters = () => {
      bookGrid.querySelectorAll('.meter span').forEach((bar) => {
        bar.style.width = `${bar.dataset.p || 0}%`;
      });
    };

    const applyFilterSort = () => {
      const q = searchInput.value.trim().toLowerCase();
      const type = sortSelect.value;
      const filtered = books.filter((book) => {
        const text = `${book.dataset.title} ${book.dataset.author}`.toLowerCase();
        const matched = text.includes(q);
        book.hidden = !matched;
        return matched;
      });

      if (type === 'title') {
        filtered.sort((a, b) => String(a.dataset.title).localeCompare(String(b.dataset.title), 'zh-CN'));
      }
      if (type === 'progress') {
        filtered.sort((a, b) => Number(b.dataset.progress) - Number(a.dataset.progress));
      }
      filtered.forEach((book) => bookGrid.appendChild(book));
      resultCount.textContent = `${filtered.length} results`;
    };

    sizeRange.addEventListener('input', () => {
      const size = Number(sizeRange.value);
      sizeLabel.textContent = String(size);
      sizeWarning.hidden = size <= 50;
      formatWarning.hidden = true;
    });

    const setStage = (stageName, status, percent) => {
      const textMap = { ready: 'Ready', running: 'Running', done: 'Done', failed: 'Failed' };
      const targetLabel = stageName === 'validate' ? stageValidate : stageName === 'meta' ? stageMeta : stageRag;
      targetLabel.textContent = textMap[status] || 'Ready';
      importBars[stageName].style.width = `${percent}%`;
    };

    const resetStages = () => {
      setStage('validate', 'ready', 0);
      setStage('meta', 'ready', 0);
      setStage('rag', 'ready', 0);
    };

    const runImportDemo = () => {
      resetStages();
      formatWarning.hidden = true;
      const size = Number(sizeRange.value);

      setStage('validate', 'running', 35);
      setTimeout(() => {
        setStage('validate', 'done', 100);
        setStage('meta', 'running', 38);
      }, 320);

      setTimeout(() => {
        if (size > 110) {
          setStage('meta', 'failed', 100);
          formatWarning.hidden = false;
          return;
        }
        setStage('meta', 'done', 100);
        setStage('rag', 'running', 30);
      }, 760);

      setTimeout(() => {
        if (size > 110) return;
        setStage('rag', 'done', 100);
      }, 1280);
    };

    ['dragenter', 'dragover'].forEach((evt) => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.add('active');
      });
    });
    ['dragleave', 'drop'].forEach((evt) => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        dropzone.classList.remove('active');
        if (evt === 'drop') runImportDemo();
      });
    });

    searchInput.addEventListener('input', applyFilterSort);
    sortSelect.addEventListener('change', applyFilterSort);
    document.getElementById('importBtn').addEventListener('click', runImportDemo);

    bookGrid.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains('delete-btn')) return;
      const card = target.closest('.book');
      if (card) {
        card.remove();
        applyFilterSort();
      }
    });

    themeToggle.addEventListener('click', () => {
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
    });

    window.addEventListener('keydown', (event) => {
      const meta = event.ctrlKey || event.metaKey;
      if (meta && event.key.toLowerCase() === 'f') {
        event.preventDefault();
        searchInput.focus();
      }
      if (meta && event.key.toLowerCase() === 'i') {
        event.preventDefault();
        document.getElementById('importBtn').focus();
        runImportDemo();
      }
    });

    applyFilterSort();
    syncMeters();
    resetStages();
  </script>
</body>
</html>
