<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Reader - Reader Prototype (Plan Aligned)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../tokens.css">
  <style>
    :root {
      --left-pane: 300px;
      --right-pane: 420px;
      --reader-font-size: 18px;
      --reader-line-height: 1.88;
      --reader-width: 760px;
    }

    body {
      height: 100vh;
      overflow: hidden;
    }

    .app {
      height: 100vh;
      display: grid;
      grid-template-rows: var(--app-titlebar-h) 1fr var(--app-statusbar-h);
    }

    .title-left {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .title-left h1 {
      margin: 0;
      font-family: var(--font-ui);
      font-size: 13px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45vw;
    }

    .workspace {
      min-height: 0;
      display: grid;
      grid-template-columns: var(--left-pane) minmax(0, 1fr) var(--right-pane);
      border-top: var(--md-border-strong);
      border-bottom: var(--md-border-strong);
    }

    .pane {
      min-height: 0;
      background: color-mix(in srgb, var(--md-surface-1) 94%, transparent);
    }

    .left {
      border-right: var(--md-border-strong);
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 8px;
      padding: 10px;
    }

    .left .tabs {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
    }

    .left-tab {
      border: var(--md-border-strong);
      border-radius: 6px;
      background: var(--md-surface-1);
      padding: 7px;
      text-align: center;
      font-family: var(--font-ui);
      font-size: 11px;
      text-transform: uppercase;
      cursor: pointer;
    }

    .left-tab.active {
      background: var(--md-sun);
    }

    .left-view {
      min-height: 0;
      overflow: auto;
      display: none;
      gap: 6px;
      align-content: start;
    }

    .left-view.active {
      display: grid;
    }

    .chapter-item,
    .bookmark-item {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 8px 9px;
      cursor: pointer;
      display: grid;
      gap: 3px;
      transition: transform var(--dur-fast) var(--ease-out), background-color var(--dur-fast) var(--ease-out), border-color var(--dur-fast) var(--ease-out);
    }

    .chapter-item:hover,
    .bookmark-item:hover {
      transform: translateY(-1px);
      border-color: var(--md-border-mid);
      background: var(--md-surface-2);
    }

    .chapter-item.active {
      border: var(--md-border-strong);
      background: color-mix(in srgb, var(--md-sky) 24%, var(--md-surface-1));
    }

    .chapter-item strong,
    .bookmark-item strong {
      font-size: 14px;
      line-height: 1.35;
    }

    .chapter-item small,
    .bookmark-item small {
      font-size: 12px;
      color: var(--md-ink-soft);
    }

    .reader {
      min-height: 0;
      display: grid;
      grid-template-rows: auto 1fr;
      background: linear-gradient(180deg, color-mix(in srgb, var(--md-surface-2) 90%, transparent), color-mix(in srgb, var(--md-surface-1) 96%, transparent));
    }

    .reader-toolbar {
      border-bottom: var(--md-border-strong);
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--md-surface-1);
    }

    .reader-toolbar .group {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .reader-scroll {
      min-height: 0;
      overflow: auto;
      padding: 16px;
      position: relative;
    }

    .progress {
      width: min(var(--reader-width), 100%);
      height: 10px;
      margin: 0 auto 9px;
      border: var(--md-border-strong);
      border-radius: 999px;
      background: var(--md-surface-1);
      overflow: hidden;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .progress span {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--md-sky), var(--md-sun), var(--md-orange));
    }

    .paper {
      width: min(var(--reader-width), 100%);
      margin: 0 auto;
      border: var(--md-border-strong);
      border-radius: 10px;
      background: var(--md-surface-1);
      box-shadow: var(--md-shadow-lift);
      padding: 18px clamp(14px, 3vw, 32px) 22px;
      position: relative;
    }

    .paper h2 {
      margin: 0 0 12px;
      font-size: clamp(26px, 3vw, 38px);
      line-height: 1.1;
      letter-spacing: -0.015em;
    }

    .paper p {
      margin: 0 0 15px;
      font-size: var(--reader-font-size);
      line-height: var(--reader-line-height);
    }

    .mark {
      background: color-mix(in srgb, var(--md-sun) 52%, var(--md-surface-1));
      border: 1px dashed var(--md-ink);
      padding: 0 2px;
    }

    .selection-toolbar {
      position: absolute;
      z-index: 30;
      display: none;
      gap: 6px;
      border: var(--md-border-strong);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 6px;
      box-shadow: var(--md-shadow-float);
    }

    .selection-toolbar.visible {
      display: inline-flex;
    }

    .right {
      border-left: var(--md-border-strong);
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      min-height: 0;
    }

    .workspace.ai-collapsed {
      --right-pane: 56px;
    }

    .workspace.ai-collapsed .right {
      grid-template-rows: auto 1fr;
    }

    .workspace.ai-collapsed .right-head {
      border-bottom: none;
      padding: 8px 4px;
      flex-direction: column;
      justify-content: flex-start;
    }

    .workspace.ai-collapsed .right-head .right-title,
    .workspace.ai-collapsed .right-head .right-chip {
      display: none;
    }

    .workspace.ai-collapsed .ai-tabs,
    .workspace.ai-collapsed .ai-body,
    .workspace.ai-collapsed .ai-input {
      display: none;
    }

    .right-head {
      border-bottom: var(--md-border-strong);
      padding: 8px 9px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      background: var(--md-surface-1);
    }

    .ai-tabs {
      border-bottom: var(--md-border-strong);
      padding: 8px 9px;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 6px;
      background: var(--md-surface-1);
    }

    .ai-tab {
      border: var(--md-border-strong);
      border-radius: 6px;
      background: var(--md-surface-1);
      text-align: center;
      padding: 6px;
      font-family: var(--font-ui);
      font-size: 11px;
      text-transform: uppercase;
      cursor: pointer;
    }

    .ai-tab.active {
      background: var(--md-sun);
    }

    .ai-body {
      min-height: 0;
      position: relative;
    }

    .ai-view {
      position: absolute;
      inset: 0;
      overflow: auto;
      padding: 9px;
      display: none;
      gap: 7px;
      align-content: start;
    }

    .ai-view.active {
      display: grid;
    }

    .bubble {
      border: var(--md-border-strong);
      border-radius: 8px;
      padding: 8px 9px;
      font-size: 14px;
      line-height: 1.56;
      background: var(--md-surface-1);
      max-width: 92%;
    }

    .bubble.ai { background: color-mix(in srgb, var(--md-sky) 24%, var(--md-surface-1)); }
    .bubble.user { background: color-mix(in srgb, var(--md-sun) 34%, var(--md-surface-1)); justify-self: end; }
    .bubble.typing::after { content: "|"; animation: md-blink 1s infinite; }

    .panel-item {
      border: var(--md-border-strong);
      border-radius: 8px;
      background: var(--md-surface-1);
      padding: 8px;
      font-size: 14px;
    }

    .panel-item .k {
      font-family: var(--font-ui);
      text-transform: uppercase;
      font-size: 11px;
      color: var(--md-ink-soft);
      margin-bottom: 4px;
      display: inline-block;
    }

    .graph {
      border: var(--md-border-strong);
      border-radius: 8px;
      min-height: 190px;
      position: relative;
      overflow: hidden;
      background: var(--md-surface-1);
    }

    .graph::before,
    .graph::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      border-top: 1px dashed var(--md-border-mid);
    }

    .graph::before { top: 33%; }
    .graph::after { top: 66%; }

    .node {
      position: absolute;
      border: var(--md-border-strong);
      border-radius: 999px;
      background: var(--md-surface-1);
      padding: 4px 10px;
      font-family: var(--font-ui);
      font-size: 11px;
      text-transform: uppercase;
    }

    .node.c { left: 44%; top: 40%; background: color-mix(in srgb, var(--md-sun) 60%, var(--md-surface-1)); }
    .node.n1 { left: 10%; top: 18%; background: color-mix(in srgb, var(--md-sky) 30%, var(--md-surface-1)); }
    .node.n2 { right: 10%; top: 20%; background: color-mix(in srgb, var(--md-danger) 20%, var(--md-surface-1)); }
    .node.n3 { left: 16%; bottom: 16%; background: var(--md-surface-3); }
    .node.n4 { right: 16%; bottom: 16%; background: color-mix(in srgb, var(--md-sun) 34%, var(--md-surface-1)); }

    .ai-input {
      border-top: var(--md-border-strong);
      padding: 8px 9px;
      display: grid;
      gap: 8px;
      background: var(--md-surface-1);
    }

    .history-tools {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .offline-banner {
      border: var(--md-border-strong);
      border-radius: 8px;
      background: color-mix(in srgb, var(--md-warning) 22%, var(--md-surface-1));
      padding: 7px 9px;
      font-size: 13px;
      margin: 0 auto 8px;
      width: min(var(--reader-width), 100%);
    }

    .timeline-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .shortcut-panel {
      position: fixed;
      inset: 0;
      background: rgba(16, 19, 24, 0.36);
      z-index: 120;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
    }

    .shortcut-panel.active {
      display: flex;
    }

    .shortcut-card {
      width: min(720px, 94vw);
      border: var(--md-border-strong);
      border-radius: 10px;
      background: var(--md-surface-1);
      overflow: hidden;
      box-shadow: var(--md-shadow-float);
      animation: md-rise var(--dur-mid) var(--ease-out);
    }

    .shortcut-head {
      border-bottom: var(--md-border-strong);
      padding: 9px 11px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      font-family: var(--font-ui);
      font-size: 13px;
      text-transform: uppercase;
    }

    .shortcut-body {
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .shortcut-item {
      border: var(--md-border-soft-line);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      background: var(--md-surface-1);
    }

    .status-l,
    .status-r {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .sep {
      width: 1px;
      height: 16px;
      background: var(--md-border-soft);
    }

    @media (max-width: 1380px) {
      :root {
        --right-pane: 360px;
      }
      .ai-tabs {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 1100px) {
      .workspace {
        grid-template-columns: 1fr;
      }
      .left {
        display: none;
      }
      .right {
        border-left: none;
        border-top: var(--md-border-strong);
        min-height: 340px;
      }
      .title-left h1 {
        max-width: 62vw;
      }
    }

    @media (max-width: 760px) {
      .shortcut-body {
        grid-template-columns: 1fr;
      }
      .ai-tabs {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .title-left h1 {
        max-width: 52vw;
      }
    }
  </style>
</head>
<body class="md-noise">
  <div class="app">
    <header class="md-titlebar">
      <div class="title-left">
        <span class="md-chip">Reader</span>
        <h1>《三体》 - 第 38 章：古筝行动</h1>
      </div>
      <div class="row">
        <button class="md-btn" id="bookmarkBtn">Add Bookmark</button>
        <button class="md-btn" id="themeToggle">Theme</button>
        <button class="md-btn" id="helpOpen">Shortcuts</button>
      </div>
    </header>

    <div class="workspace" id="workspace">
      <aside class="pane left">
        <input class="md-input" id="chapterSearch" placeholder="过滤章节 / 书签...">
        <div class="tabs" id="leftTabs">
          <button class="left-tab active" data-left-tab="chapters">章节</button>
          <button class="left-tab" data-left-tab="bookmarks">书签</button>
        </div>

        <div class="left-view active" data-left-view="chapters" id="chapterList">
          <article class="chapter-item"><strong>第 34 章 · 黑暗森林法则</strong><small>已读 · 标注 6 · 问答 4</small></article>
          <article class="chapter-item"><strong>第 35 章 · 威慑平衡</strong><small>已读 · 标注 3 · 问答 2</small></article>
          <article class="chapter-item active"><strong>第 38 章 · 古筝行动</strong><small>阅读中 · 标注 11 · 问答 9</small></article>
          <article class="chapter-item"><strong>第 39 章 · 面壁者计划</strong><small>未读 · 已生成摘要</small></article>
          <article class="chapter-item"><strong>第 40 章 · 破壁人</strong><small>未读 · 关键人物 5</small></article>
        </div>
        <div class="left-view" data-left-view="bookmarks" id="bookmarkList">
          <article class="bookmark-item"><strong>史强的判断</strong><small>第 38 章 · 段落 2</small></article>
          <article class="bookmark-item"><strong>古筝行动结论</strong><small>第 38 章 · 段落 5</small></article>
          <article class="bookmark-item"><strong>威慑定义</strong><small>第 38 章 · 段落 7</small></article>
        </div>

        <div class="panel-item">
          <span class="k">阅读设置（计划项）</span><br>
          字体/字号/行距/主题 全部可调。
        </div>
      </aside>

      <section class="pane reader">
        <div class="reader-toolbar">
          <div class="group">
            <span class="md-chip">Progress <strong id="progressLabel">0%</strong></span>
            <span class="md-chip">Offline Cached Analysis</span>
          </div>
          <div class="group">
            <button class="md-btn" id="fontDown">A-</button>
            <button class="md-btn" id="fontUp">A+</button>
            <button class="md-btn" id="lineDown">Line-</button>
            <button class="md-btn" id="lineUp">Line+</button>
            <button class="md-btn" id="widthDown">Width-</button>
            <button class="md-btn" id="widthUp">Width+</button>
          </div>
        </div>

        <div class="reader-scroll" id="readerScroll">
          <div class="offline-banner">网络不可用：AI 在线能力降级。可继续阅读、查看缓存分析，联网后自动恢复队列任务。</div>
          <div class="progress"><span id="progressBar"></span></div>
          <article class="paper" id="paper">
            <h2>古筝行动</h2>
            <p>凌晨时分，指挥中心的空气像被冷却过的金属。屏幕上，纳米丝阵列参数不断刷新，所有人都在等待同一个瞬间。史强抬头看向丁仪，没有说话，只把手里的咖啡推到了桌角。</p>
            <p>“开始吧。”随着指令落下，舰体切面上的光标线迅速推进。不到半秒，整条航路回波出现异常峰值。<span class="mark">这是三体组织首次遭遇不可逆技术压制。</span></p>
            <p>罗辑后来回忆那一刻，说真正的武器并不总是宏大叙事，有时只是细到几乎看不见的一条线。它安静、精确，却能在关键时刻改写局势。</p>
            <p id="cite-1">“如果这套系统出现在更大规模战场呢？”章北海的问题像石子落水。丁仪没有立刻回答，只让控制台回放三次切面数据，然后宣布：“我们有 87% 置信度重现该效果。”</p>
            <p>会后记录里，ETO 成员供述发生明显变化。此前他们相信智子足以锁死基础科学，但在这次行动之后，叙事转向：人类可能凭工程化能力获取局部决定性优势。</p>
            <p>夜里两点，会议室终于安静下来。史强合上文件夹，低声说：“别急着庆祝，故事到这里才刚开始。”</p>

            <div class="selection-toolbar" id="selectionToolbar">
              <button class="md-btn md-btn-primary" style="padding:6px 10px;">提问</button>
              <button class="md-btn" style="padding:6px 10px;">人物</button>
              <button class="md-btn" style="padding:6px 10px;">时间线</button>
              <button class="md-btn" style="padding:6px 10px;">事件</button>
            </div>
          </article>
        </div>
      </section>

      <aside class="pane right">
        <div class="right-head">
          <span class="md-ui right-title">AI Workspace</span>
          <span class="md-chip right-chip">Hybrid RAG + 引用定位</span>
          <button class="md-btn" id="aiCollapseToggle">Collapse</button>
        </div>

        <div class="ai-tabs" id="aiTabs">
          <button class="ai-tab active" data-tab="qa">Q&A</button>
          <button class="ai-tab" data-tab="characters">人物</button>
          <button class="ai-tab" data-tab="timeline">时间线</button>
          <button class="ai-tab" data-tab="events">事件</button>
          <button class="ai-tab" data-tab="templates">模板</button>
          <button class="ai-tab" data-tab="history">历史</button>
        </div>

        <div class="ai-body">
          <section class="ai-view active" data-view="qa" id="qaView">
            <article class="bubble ai">这章核心冲突是“技术执行链”与“战略后果”。建议先看触发事件，再看认知转向。</article>
            <article class="bubble user">为什么 ETO 在这里改口？</article>
            <article class="bubble ai typing" id="typingMsg">因为结果具备可复现性，改变了对人类工程能力的预期</article>
            <article class="panel-item"><span class="k">检索模式</span><br>混合检索：向量召回 + FTS 全文检索（计划 Step 7）。</article>
            <article class="panel-item"><span class="k">Citation</span><br>证据: 第 38 章第 3 段/第 5 段。<a href="#cite-1">跳转原文位置</a></article>
          </section>

          <section class="ai-view" data-view="characters">
            <article class="panel-item"><span class="k">人物提取</span><br>支持手动添加/编辑、别名合并、关系强度修正。</article>
            <div class="graph">
              <span class="node c">罗辑</span>
              <span class="node n1">史强</span>
              <span class="node n2">丁仪</span>
              <span class="node n3">章北海</span>
              <span class="node n4">ETO</span>
            </div>
            <div class="row">
              <button class="md-btn">Add Character</button>
              <button class="md-btn">Edit Relation</button>
              <button class="md-btn">Export JSON</button>
            </div>
          </section>

          <section class="ai-view" data-view="timeline">
            <article class="panel-item"><span class="k">时间线筛选</span><br>范围筛选/人物筛选/关键词搜索/手动编辑。</article>
            <div class="timeline-controls">
              <select class="md-select"><option>垂直时间线</option><option>水平时间线</option></select>
              <label class="panel-item" style="padding:6px 8px; font-size:12px;">缩放
                <input type="range" min="1" max="4" step="1" value="2">
              </label>
            </div>
            <article class="panel-item"><span class="k">T-00:30</span><br>参数复核完成，阵列预热。</article>
            <article class="panel-item"><span class="k">T+00:00</span><br>指令下达，舰体回波异常。</article>
            <article class="panel-item"><span class="k">T+00:05</span><br>会议回放验证，可复现确认。</article>
            <div class="row">
              <button class="md-btn">Filter</button>
              <button class="md-btn">Edit Event</button>
            </div>
          </section>

          <section class="ai-view" data-view="events">
            <article class="panel-item"><span class="k">事件分类</span><br><span class="md-chip">TURNING_POINT</span> <span class="md-chip">CONFLICT</span> <span class="md-chip">DIALOGUE</span></article>
            <article class="panel-item"><span class="k">Cause</span><br>纳米丝行动成功展示工程精度。</article>
            <article class="panel-item"><span class="k">Effect</span><br>叙事从绝对悲观转向局部可对抗。</article>
            <article class="panel-item"><span class="k">Importance</span><br>高（关键转折点）。</article>
            <article class="panel-item"><span class="k">章节概览</span><br>第 38 章：关键事件 3 / 关联人物 5 / 可定位原文 3 处。</article>
            <div class="row">
              <button class="md-btn">Sort by Importance</button>
              <button class="md-btn">Open Causal Chain</button>
            </div>
          </section>

          <section class="ai-view" data-view="templates">
            <article class="panel-item"><span class="k">人物问题模板</span><br>“X 在本章的关键行为是什么？给证据。”</article>
            <article class="panel-item"><span class="k">剧情问题模板</span><br>“这一事件如何影响后续章节？”</article>
            <article class="panel-item"><span class="k">主题问题模板</span><br>“本章如何体现威慑主题？”</article>
            <div class="row">
              <button class="md-btn">Use Template</button>
            </div>
          </section>

          <section class="ai-view" data-view="history">
            <input class="md-input" id="historySearch" placeholder="搜索对话历史...">
            <article class="panel-item"><span class="k">2026-02-17 14:12</span><br>问题：为什么 ETO 改口？</article>
            <article class="panel-item"><span class="k">2026-02-17 13:46</span><br>问题：本章关键人物关系？</article>
            <div class="history-tools">
              <button class="md-btn">Export JSON</button>
              <button class="md-btn">Export History</button>
              <button class="md-btn">Clear</button>
            </div>
          </section>
        </div>

        <div class="ai-input">
          <textarea class="md-textarea" id="askInput" placeholder="问 AI：这段里谁推动了情节？请引用原文。"></textarea>
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
            <span class="md-chip" id="costChip">Token Est: 1.8k / Cost Est: $0.06</span>
            <button class="md-btn md-btn-primary" id="sendBtn">发送问题</button>
          </div>
        </div>
      </aside>
    </div>

    <footer class="md-statusbar">
      <div class="status-l">
        <span><i class="md-status-dot md-status-warn"></i>Offline Degraded Mode</span>
        <span class="sep"></span>
        <span>Auto-save: ON</span>
        <span class="sep"></span>
        <span>Token Today: 182k</span>
      </div>
      <div class="status-r">
        <span class="md-kbd">Ctrl/Cmd + Enter</span>
        <span class="md-kbd">Ctrl/Cmd + B</span>
        <span class="md-kbd">Ctrl/Cmd + \</span>
        <span class="md-kbd">?</span>
      </div>
    </footer>
  </div>

  <div class="shortcut-panel" id="shortcutPanel">
    <div class="shortcut-card">
      <div class="shortcut-head">
        <span>Keyboard Shortcuts</span>
        <button class="md-btn" id="helpClose" style="padding:6px 10px;">Close</button>
      </div>
      <div class="shortcut-body">
        <div class="shortcut-item"><span>发送问题</span><span class="md-kbd">Ctrl/Cmd + Enter</span></div>
        <div class="shortcut-item"><span>添加书签</span><span class="md-kbd">Ctrl/Cmd + B</span></div>
        <div class="shortcut-item"><span>收起 AI 面板</span><span class="md-kbd">Ctrl/Cmd + \</span></div>
        <div class="shortcut-item"><span>打开帮助</span><span class="md-kbd">?</span></div>
        <div class="shortcut-item"><span>关闭弹层</span><span class="md-kbd">Esc</span></div>
      </div>
    </div>
  </div>

  <script>
    const root = document.documentElement;
    const workspace = document.getElementById('workspace');
    const themeToggle = document.getElementById('themeToggle');
    const readerScroll = document.getElementById('readerScroll');
    const progressBar = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');
    const paper = document.getElementById('paper');
    const selectionToolbar = document.getElementById('selectionToolbar');
    const leftTabs = document.querySelectorAll('.left-tab');
    const leftViews = document.querySelectorAll('.left-view');
    const aiTabs = document.querySelectorAll('.ai-tab');
    const aiViews = document.querySelectorAll('.ai-view');
    const chapterSearch = document.getElementById('chapterSearch');
    const askInput = document.getElementById('askInput');
    const sendBtn = document.getElementById('sendBtn');
    const qaView = document.getElementById('qaView');
    const typingMsg = document.getElementById('typingMsg');
    const shortcutPanel = document.getElementById('shortcutPanel');
    const helpOpen = document.getElementById('helpOpen');
    const helpClose = document.getElementById('helpClose');
    const aiCollapseToggle = document.getElementById('aiCollapseToggle');
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    const bookmarkList = document.getElementById('bookmarkList');
    const historySearch = document.getElementById('historySearch');
    const historyItems = Array.from(document.querySelectorAll('[data-view="history"] .panel-item'));
    const costChip = document.getElementById('costChip');

    const updateProgress = () => {
      const max = readerScroll.scrollHeight - readerScroll.clientHeight;
      const ratio = max > 0 ? readerScroll.scrollTop / max : 0;
      const percent = Math.max(0, Math.min(100, ratio * 100));
      progressBar.style.width = `${percent}%`;
      progressLabel.textContent = `${Math.round(percent)}%`;
    };

    readerScroll.addEventListener('scroll', updateProgress);
    updateProgress();

    const showSelectionToolbar = () => {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0 || selection.toString().trim().length === 0) {
        selectionToolbar.classList.remove('visible');
        return;
      }
      const range = selection.getRangeAt(0);
      if (!paper.contains(range.commonAncestorContainer)) {
        selectionToolbar.classList.remove('visible');
        return;
      }
      const rect = range.getBoundingClientRect();
      const host = paper.getBoundingClientRect();
      selectionToolbar.style.left = `${Math.max(8, rect.left - host.left)}px`;
      selectionToolbar.style.top = `${Math.max(8, rect.top - host.top - 52)}px`;
      selectionToolbar.classList.add('visible');
    };

    paper.addEventListener('mouseup', () => requestAnimationFrame(showSelectionToolbar));
    readerScroll.addEventListener('scroll', () => selectionToolbar.classList.remove('visible'));

    leftTabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        leftTabs.forEach((t) => t.classList.toggle('active', t === tab));
        leftViews.forEach((view) => view.classList.toggle('active', view.dataset.leftView === tab.dataset.leftTab));
      });
    });

    aiTabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        aiTabs.forEach((t) => t.classList.toggle('active', t === tab));
        aiViews.forEach((view) => view.classList.toggle('active', view.dataset.view === tab.dataset.tab));
      });
    });

    chapterSearch.addEventListener('input', () => {
      const q = chapterSearch.value.trim().toLowerCase();
      document.querySelectorAll('#chapterList .chapter-item, #bookmarkList .bookmark-item').forEach((item) => {
        const matched = item.textContent.toLowerCase().includes(q);
        item.hidden = !matched;
      });
    });

    historySearch.addEventListener('input', () => {
      const q = historySearch.value.trim().toLowerCase();
      historyItems.forEach((item) => {
        item.hidden = !item.textContent.toLowerCase().includes(q);
      });
    });

    const setAiCollapsed = (collapsed) => {
      workspace.classList.toggle('ai-collapsed', collapsed);
      aiCollapseToggle.textContent = collapsed ? 'Expand' : 'Collapse';
    };

    aiCollapseToggle.addEventListener('click', () => {
      setAiCollapsed(!workspace.classList.contains('ai-collapsed'));
    });

    const adjustVar = (name, delta, min, max, digits = 2) => {
      const current = Number.parseFloat(getComputedStyle(root).getPropertyValue(name)) || min;
      const next = Math.max(min, Math.min(max, current + delta));
      const suffix = name.includes('line-height') ? '' : 'px';
      root.style.setProperty(name, `${Number(next.toFixed(digits))}${suffix}`);
    };

    document.getElementById('fontUp').addEventListener('click', () => adjustVar('--reader-font-size', 1, 15, 24, 0));
    document.getElementById('fontDown').addEventListener('click', () => adjustVar('--reader-font-size', -1, 15, 24, 0));
    document.getElementById('lineUp').addEventListener('click', () => adjustVar('--reader-line-height', 0.05, 1.45, 2.2, 2));
    document.getElementById('lineDown').addEventListener('click', () => adjustVar('--reader-line-height', -0.05, 1.45, 2.2, 2));
    document.getElementById('widthUp').addEventListener('click', () => adjustVar('--reader-width', 20, 620, 980, 0));
    document.getElementById('widthDown').addEventListener('click', () => adjustVar('--reader-width', -20, 620, 980, 0));

    askInput.addEventListener('input', () => {
      const tokenEstimate = Math.max(250, Math.round(askInput.value.trim().length * 1.6 + 600));
      const estimatedCost = (tokenEstimate / 1000) * 0.035;
      costChip.textContent = `Token Est: ${(tokenEstimate / 1000).toFixed(1)}k / Cost Est: $${estimatedCost.toFixed(2)}`;
    });

    const sendAsk = () => {
      const text = askInput.value.trim();
      if (!text) {
        askInput.focus();
        return;
      }
      const tokenEstimate = Math.max(250, Math.round(text.length * 1.6 + 600));
      const estimateCost = (tokenEstimate / 1000) * 0.035;
      const highCostThreshold = 0.25;
      if (estimateCost > highCostThreshold) {
        const confirmed = window.confirm(`本次请求预计成本 $${estimateCost.toFixed(2)}，超过阈值 $${highCostThreshold.toFixed(2)}，是否继续？`);
        if (!confirmed) return;
      }

      aiTabs.forEach((tab) => tab.classList.toggle('active', tab.dataset.tab === 'qa'));
      aiViews.forEach((view) => view.classList.toggle('active', view.dataset.view === 'qa'));
      const user = document.createElement('article');
      user.className = 'bubble user';
      user.textContent = text;
      qaView.appendChild(user);
      const ai = document.createElement('article');
      ai.className = 'bubble ai typing';
      ai.textContent = '正在结合当前章节与历史上下文生成回答';
      qaView.appendChild(ai);
      askInput.value = '';
      qaView.scrollTop = qaView.scrollHeight;
      setTimeout(() => {
        ai.classList.remove('typing');
        ai.textContent = '建议继续追问“这一事件影响了哪些后续人物选择”，我可按人物与证据列表回答。';
      }, 1200);
    };

    sendBtn.addEventListener('click', sendAsk);

    bookmarkBtn.addEventListener('click', () => {
      const item = document.createElement('article');
      item.className = 'bookmark-item';
      item.innerHTML = '<strong>新书签</strong><small>当前段落 · 刚刚</small>';
      bookmarkList.prepend(item);
    });

    themeToggle.addEventListener('click', () => {
      const isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
    });

    helpOpen.addEventListener('click', () => shortcutPanel.classList.add('active'));
    helpClose.addEventListener('click', () => shortcutPanel.classList.remove('active'));
    shortcutPanel.addEventListener('click', (e) => {
      if (e.target === shortcutPanel) shortcutPanel.classList.remove('active');
    });

    window.addEventListener('keydown', (event) => {
      const meta = event.ctrlKey || event.metaKey;
      if (meta && event.key === 'Enter') {
        event.preventDefault();
        sendAsk();
      }
      if (meta && event.key.toLowerCase() === 'b') {
        event.preventDefault();
        bookmarkBtn.click();
      }
      if (meta && event.key === '\\') {
        event.preventDefault();
        setAiCollapsed(!workspace.classList.contains('ai-collapsed'));
      }
      if (!meta && event.key === '?') {
        event.preventDefault();
        shortcutPanel.classList.add('active');
      }
      if (event.key === 'Escape') {
        shortcutPanel.classList.remove('active');
      }
    });

    typingMsg.classList.remove('typing');
    setAiCollapsed(false);
  </script>
</body>
</html>
