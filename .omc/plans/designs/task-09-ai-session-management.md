# P2-2: AIä¼šè¯ç®¡ç†è®¾è®¡

## é—®é¢˜èƒŒæ™¯

åŸå‹å®¡æŸ¥æŠ¥å‘Šä¸­æŒ‡å‡ºï¼š**æ— ä¼šè¯ç®¡ç†è®¾è®¡ - ä¼šè¯åˆ—è¡¨ã€å‘½åã€åˆ é™¤**

è¿™æ˜¯ä¸€ä¸ª **Minor** çº§åˆ«çš„é—®é¢˜ï¼Œä½†å½±å“ç”¨æˆ·ç®¡ç†å¤šä¸ªå¯¹è¯çš„èƒ½åŠ›ã€‚

---

## è®¾è®¡æ–¹æ¡ˆ

### 1. ä¼šè¯åˆ—è¡¨é¢æ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– AI é—®ç­”                                         [+ æ–°å»º] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” æœç´¢ä¼šè¯...                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ğŸ“Œ å›ºå®šä¼šè¯                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¬ ä¸‰ä½“æ–‡æ˜ç›¸å…³è®¨è®º                       ğŸ“Œ â‹®        â”‚   â”‚
â”‚  â”‚ æœ€åæ›´æ–°: 2 å°æ—¶å‰                                  â”‚   â”‚
â”‚  â”‚ ğŸ“š ä¸‰ä½“ | 12 æ¡æ¶ˆæ¯                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ğŸ“… ä»Šå¤©                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¬ å¶æ–‡æ´äººç‰©åˆ†æ                         â‹®          â”‚   â”‚
â”‚  â”‚ æœ€åæ›´æ–°: 30 åˆ†é’Ÿå‰                                 â”‚   â”‚
â”‚  â”‚ ğŸ“š ä¸‰ä½“ | 8 æ¡æ¶ˆæ¯                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ğŸ“… æ˜¨å¤©                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¬ ç« èŠ‚æ‘˜è¦ - çº¢å²¸åŸºåœ°                    â‹®          â”‚   â”‚
â”‚  â”‚ æœ€åæ›´æ–°: æ˜¨å¤© 15:30                                â”‚   â”‚
â”‚  â”‚ ğŸ“š ä¸‰ä½“ | 5 æ¡æ¶ˆæ¯                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’¬ æœªå‘½åä¼šè¯                            â‹®          â”‚   â”‚
â”‚  â”‚ æœ€åæ›´æ–°: æ˜¨å¤© 10:15                                â”‚   â”‚
â”‚  â”‚ ğŸ“š ä¸‰ä½“ | 3 æ¡æ¶ˆæ¯                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ğŸ“ å·²å½’æ¡£                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“¦ æ—§ä¹¦è®¨è®º (3 ä¸ªä¼šè¯)                    [å±•å¼€]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ä¼šè¯æ“ä½œèœå•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœï¸ é‡å‘½å       â”‚
â”‚ ğŸ“Œ å›ºå®š/å–æ¶ˆå›ºå®š â”‚
â”‚ ğŸ“¦ å½’æ¡£         â”‚
â”‚ ğŸ“¤ å¯¼å‡º         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ—‘ï¸ åˆ é™¤        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ•°æ®æ¨¡å‹

```typescript
/**
 * AI ä¼šè¯
 */
interface AISession {
  /** ä¼šè¯å”¯ä¸€æ ‡è¯† */
  id: string;
  
  /** ä¼šè¯æ ‡é¢˜ï¼ˆç”¨æˆ·è®¾ç½®æˆ– AI ç”Ÿæˆï¼‰ */
  title: string;
  
  /** å…³è”çš„ä¹¦ç± ID */
  bookId?: string;
  
  /** å…³è”çš„ç« èŠ‚èŒƒå›´ */
  chapterScope?: {
    startChapterId?: string;
    endChapterId?: string;
  };
  
  /** æ˜¯å¦å›ºå®š */
  isPinned: boolean;
  
  /** æ˜¯å¦å½’æ¡£ */
  isArchived: boolean;
  
  /** å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ */
  messages: AIMessage[];
  
  /** ä¼šè¯æ‘˜è¦ï¼ˆAI ç”Ÿæˆï¼‰ */
  summary?: string;
  
  /** åˆ›å»ºæ—¶é—´ */
  createdAt: string;
  
  /** æ›´æ–°æ—¶é—´ */
  updatedAt: string;
}

/**
 * AI æ¶ˆæ¯
 */
interface AIMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
  
  /** å…³è”çš„å¼•ç”¨ï¼ˆå¦‚æœ‰ï¼‰ */
  references?: {
    chapterId: string;
    paragraphId?: string;
    text: string;
  }[];
}

/**
 * ä¼šè¯åˆ›å»ºå‚æ•°
 */
interface CreateSessionParams {
  bookId?: string;
  initialMessage?: string;
  title?: string;
}

/**
 * ä¼šè¯å¯¼å‡ºæ ¼å¼
 */
type SessionExportFormat = 'markdown' | 'json' | 'txt';
```

### 4. äº¤äº’æµç¨‹

```mermaid
flowchart TD
    A[ç‚¹å‡»æ–°å»ºä¼šè¯] --> B[åˆ›å»ºç©ºç™½ä¼šè¯]
    B --> C[æ˜¾ç¤ºæ–°ä¼šè¯ç•Œé¢]
    C --> D[ç”¨æˆ·å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯]
    D --> E{æ˜¯å¦éœ€è¦ç”Ÿæˆæ ‡é¢˜?}
    E -->|æ˜¯| F[AI ç”Ÿæˆæ ‡é¢˜]
    E -->|å¦| G[ä¿æŒç”¨æˆ·è®¾ç½®æ ‡é¢˜]
    F --> H[æ›´æ–°ä¼šè¯æ ‡é¢˜]
    G --> H
    
    I[å³é”®ä¼šè¯] --> J[æ˜¾ç¤ºæ“ä½œèœå•]
    J --> K{æ“ä½œé€‰æ‹©}
    K -->|é‡å‘½å| L[ç¼–è¾‘æ ‡é¢˜]
    K -->|å›ºå®š| M[åˆ‡æ¢å›ºå®šçŠ¶æ€]
    K -->|å½’æ¡£| N[ç§»åŠ¨åˆ°å½’æ¡£]
    K -->|åˆ é™¤| O[ç¡®è®¤åˆ é™¤]
    
    L --> P[ä¿å­˜æ–°æ ‡é¢˜]
    M --> Q[æ›´æ–°åˆ—è¡¨ä½ç½®]
    N --> R[ç§»åŠ¨åˆ°å½’æ¡£åŒº]
    O --> S[åˆ é™¤ä¼šè¯æ•°æ®]
```

### 5. æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆ

```typescript
/**
 * æ ¹æ®é¦–æ¡æ¶ˆæ¯ç”Ÿæˆä¼šè¯æ ‡é¢˜
 */
const generateSessionTitle = async (firstMessage: string): Promise<string> => {
  // 1. æˆªå–å‰ 20 ä¸ªå­—ç¬¦ä½œä¸ºå¤‡é€‰
  const truncated = firstMessage.slice(0, 20);
  
  // 2. æˆ–è€…è°ƒç”¨ AI ç”Ÿæˆæ›´åˆé€‚çš„æ ‡é¢˜
  const aiGenerated = await generateTitleWithAI(firstMessage);
  
  return aiGenerated || truncated + '...';
};
```

### 6. ä¼šè¯å­˜å‚¨

```typescript
/**
 * ä¼šè¯å­˜å‚¨ç»“æ„
 */
interface SessionStorage {
  sessions: AISession[];
  activeSessionId: string | null;
}

/**
 * å­˜å‚¨é”®å
 */
const STORAGE_KEY = 'ai-reader-sessions';

/**
 * åŠ è½½æ‰€æœ‰ä¼šè¯
 */
const loadSessions = (): SessionStorage => {
  const data = localStorage.getItem(STORAGE_KEY);
  return data ? JSON.parse(data) : { sessions: [], activeSessionId: null };
};

/**
 * ä¿å­˜ä¼šè¯
 */
const saveSession = (session: AISession) => {
  const storage = loadSessions();
  const index = storage.sessions.findIndex(s => s.id === session.id);
  
  if (index >= 0) {
    storage.sessions[index] = session;
  } else {
    storage.sessions.push(session);
  }
  
  localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
};

/**
 * åˆ é™¤ä¼šè¯
 */
const deleteSession = (sessionId: string) => {
  const storage = loadSessions();
  storage.sessions = storage.sessions.filter(s => s.id !== sessionId);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(storage));
};
```

### 7. å¯¼å‡ºåŠŸèƒ½

```typescript
/**
 * å¯¼å‡ºä¼šè¯ä¸º Markdown
 */
const exportAsMarkdown = (session: AISession): string => {
  let md = `# ${session.title}\n\n`;
  md += `> åˆ›å»ºäº: ${session.createdAt}\n\n`;
  md += `---\n\n`;
  
  for (const msg of session.messages) {
    const role = msg.role === 'user' ? '**ç”¨æˆ·**' : '**AI**';
    md += `${role}: ${msg.content}\n\n`;
  }
  
  return md;
};
```

---

## éªŒæ”¶æ ‡å‡†

- [ ] ä¼šè¯åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- [ ] å¯æ–°å»ºä¼šè¯
- [ ] å¯é‡å‘½åä¼šè¯
- [ ] å¯å›ºå®š/å–æ¶ˆå›ºå®šä¼šè¯
- [ ] å¯å½’æ¡£/æ¢å¤ä¼šè¯
- [ ] å¯åˆ é™¤ä¼šè¯
- [ ] ä¼šè¯æ ‡é¢˜å¯è‡ªåŠ¨ç”Ÿæˆ
- [ ] å¯å¯¼å‡ºä¼šè¯å†…å®¹
